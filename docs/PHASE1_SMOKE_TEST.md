# Phase 1 Smoke Test Guide (macOS)

This document provides step-by-step instructions for manually testing WorkspaceBrain Phase 1 functionality on macOS.

## Prerequisites

- Python 3.11+
- macOS (tested on Darwin 25.1.0)

## Setup

### 1. Create and activate virtual environment

```bash
cd /path/to/workspacebrain
python3 -m venv .venv
source .venv/bin/activate
```

### 2. Install WorkspaceBrain in development mode

```bash
pip install -e .
```

### 3. Verify installation

```bash
workspacebrain --version
# Expected: workspacebrain version 0.1.0 (or current version)

workspacebrain --help
# Should display available commands: init, scan, link, doctor
```

## Create Test Workspace

### 1. Create workspace with example projects

```bash
# Create workspace root
mkdir -p ~/test_workspace

# Create API project (Python backend)
mkdir -p ~/test_workspace/api
cat > ~/test_workspace/api/pyproject.toml << 'EOF'
[project]
name = "api"
version = "0.1.0"
dependencies = ["fastapi", "uvicorn"]
EOF

cat > ~/test_workspace/api/requirements.txt << 'EOF'
fastapi>=0.100.0
uvicorn>=0.23.0
pydantic>=2.0.0
EOF

# Create Web project (Node frontend)
mkdir -p ~/test_workspace/web
cat > ~/test_workspace/web/package.json << 'EOF'
{
  "name": "web",
  "version": "1.0.0",
  "dependencies": {
    "react": "^18.2.0",
    "next": "^14.0.0"
  }
}
EOF
```

## Run Smoke Test

### Step 1: Initialize Brain

```bash
workspacebrain init ~/test_workspace
```

**Expected output:**
```
Brain initialized successfully at ~/test_workspace/brain

Created:
  - brain/README.md
  - brain/MANIFEST.yaml
  - brain/DECISIONS.md
  - brain/CONTRACTS/
  - brain/HANDOFFS/
  - brain/RULES/
  - brain/RULES/INDEX.md
```

**Verify file structure:**
```bash
ls -la ~/test_workspace/brain/
# Expected:
# drwxr-xr-x  CONTRACTS
# -rw-r--r--  DECISIONS.md
# drwxr-xr-x  HANDOFFS
# -rw-r--r--  MANIFEST.yaml
# -rw-r--r--  README.md
# drwxr-xr-x  RULES
```

### Step 2: Scan for Projects

```bash
workspacebrain scan ~/test_workspace
```

**Expected output:**
```
Scanning workspace...

Detected projects:
  api (python-be) - confidence: 0.8+
    Signals: pyproject.toml, requirements.txt
  web (node-fe) - confidence: 0.7+
    Signals: package.json, react dependency

Updated MANIFEST.yaml with 2 projects.
```

**Verify MANIFEST.yaml:**
```bash
cat ~/test_workspace/brain/MANIFEST.yaml
# Expected: detected_projects list with api and web entries
```

### Step 3: Link Projects to Brain

```bash
workspacebrain link ~/test_workspace
```

**Expected output:**
```
Linking projects to brain...

Linked:
  api -> .brain (symlink)
  web -> .brain (symlink)

Generated:
  api/CLAUDE.md
  api/CURSOR_RULES.md
  api/AI.md
  web/CLAUDE.md
  web/CURSOR_RULES.md
  web/AI.md
```

**Verify symlinks:**
```bash
# Check symlink exists
ls -la ~/test_workspace/api/.brain
# Expected: .brain -> ../brain

# Verify symlink target
readlink ~/test_workspace/api/.brain
# Expected: ../brain

# Verify symlink resolves correctly
ls ~/test_workspace/api/.brain/
# Expected: CONTRACTS  DECISIONS.md  HANDOFFS  MANIFEST.yaml  README.md  RULES
```

**Verify AI rule files:**
```bash
# Check files exist
ls ~/test_workspace/api/*.md
# Expected: CLAUDE.md  CURSOR_RULES.md  AI.md

# Check header
head -5 ~/test_workspace/api/CLAUDE.md
# Expected: Contains "GENERATED BY WORKSPACEBRAIN — DO NOT EDIT"
```

### Step 4: Run Health Check

```bash
workspacebrain doctor ~/test_workspace
```

**Expected output:**
```
Brain Health Report
==================

Brain Checks:
  [OK] Brain Directory - Found at ~/test_workspace/brain
  [OK] MANIFEST.yaml - Valid (2 projects registered)
  [OK] README.md - Present
  [OK] DECISIONS.md - Present
  [OK] CONTRACTS/ - Present (0 items)
  [OK] HANDOFFS/ - Present (0 items)
  [OK] RULES/ - Present (2 items)

Project: api (python-be)
  [OK] .brain - OK: symlink (../brain)
  [OK] CLAUDE.md - In sync
  [OK] CURSOR_RULES.md - In sync
  [OK] AI.md - In sync

Project: web (node-fe)
  [OK] .brain - OK: symlink (../brain)
  [OK] CLAUDE.md - In sync
  [OK] CURSOR_RULES.md - In sync
  [OK] AI.md - In sync

Summary: 0 errors, 0 warnings
```

## Expected Final Directory Structure

```
~/test_workspace/
├── brain/
│   ├── CONTRACTS/
│   │   └── .gitkeep
│   ├── DECISIONS.md
│   ├── HANDOFFS/
│   │   └── .gitkeep
│   ├── MANIFEST.yaml
│   ├── README.md
│   └── RULES/
│       └── INDEX.md
├── api/
│   ├── .brain -> ../brain          # Symlink
│   ├── AI.md                       # Generated
│   ├── CLAUDE.md                   # Generated
│   ├── CURSOR_RULES.md             # Generated
│   ├── pyproject.toml
│   └── requirements.txt
└── web/
    ├── .brain -> ../brain          # Symlink
    ├── AI.md                       # Generated
    ├── CLAUDE.md                   # Generated
    ├── CURSOR_RULES.md             # Generated
    └── package.json
```

## Symlink vs Pointer Contract

### Primary: Relative Symlink (macOS default)

On macOS and Linux, WorkspaceBrain creates relative symlinks:

```bash
# Check symlink
ls -la ~/test_workspace/api/.brain
# lrwxr-xr-x  .brain -> ../brain
```

The symlink uses relative paths calculated based on project depth:
- Direct child: `../brain`
- Nested project: `../../brain`
- Deeply nested: `../../../brain`

### Fallback: Pointer JSON

If symlink creation fails (Windows, permission issues, unsupported filesystem):

```bash
# Instead of symlink, creates directory with JSON
ls ~/test_workspace/api/.brain/
# brain.link.json

cat ~/test_workspace/api/.brain/brain.link.json
```

**Example brain.link.json:**
```json
{
  "brain_path": "/Users/user/test_workspace/brain",
  "brain_version": "1.0",
  "workspacebrain_version": "0.1.0",
  "created_at": "2025-12-29T10:30:00",
  "note": "Fallback link file. Symlink creation failed."
}
```

### Doctor Reports

- **Symlink OK:** `[OK] .brain - OK: symlink (../brain)`
- **Pointer OK:** `[OK] .brain - OK: pointer json`
- **Broken symlink:** `[ERROR] .brain - ERROR: broken link`
- **Missing JSON:** `[ERROR] .brain - ERROR: missing json`
- **Invalid brain path:** `[ERROR] .brain - ERROR: brain bulunamadi`

## Cleanup

```bash
rm -rf ~/test_workspace
```

## Running Automated Tests

For comprehensive testing:

```bash
# Activate venv
source .venv/bin/activate

# Run all tests
pytest tests/ -v

# Run only Phase 1 integration tests
pytest tests/test_integration_phase1.py -v

# Run with coverage
pytest tests/ --cov=workspacebrain --cov-report=term-missing
```

## Troubleshooting

### "Command not found: workspacebrain"

Ensure virtual environment is activated:
```bash
source .venv/bin/activate
which workspacebrain
# Should show: /path/to/.venv/bin/workspacebrain
```

### "Brain not found" error on scan/link/doctor

Run `init` first:
```bash
workspacebrain init ~/test_workspace
```

### Symlink creation fails

Check permissions:
```bash
# Try creating a test symlink
ln -s ../test ~/test_workspace/api/test_link
ls -la ~/test_workspace/api/test_link
rm ~/test_workspace/api/test_link
```

If symlinks don't work, WorkspaceBrain will automatically fall back to pointer JSON.

### Projects not detected

Ensure signal files exist:
- Python: `pyproject.toml`, `requirements.txt`, or `setup.py`
- Node: `package.json`
- Rust: `Cargo.toml`
- Go: `go.mod`

Check scan depth (default max depth: 3 levels).
